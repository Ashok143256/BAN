<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BAN</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root {
            --primary-blue: #1e88e5;
            --primary-red: #e53935;
            --dark-blue: #1565c0;
            --dark-red: #c62828;
            --background-color: #0d1117;
            --container-bg: #161b22;
            --text-color: #e6edf3;
            --bubble-bg-me: #1e88e5;
            --bubble-text-me: #ffffff;
            --bubble-bg-other: #30363d;
            --border-color: #30363d;
            --online-status: #4caf50;
            --offline-status: #666;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 400px;
            height: 100vh;
            max-height: 100vh;
            background-color: var(--container-bg);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
        }

        /* Auth Screens */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            padding: 20px;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .screen.active {
            display: flex;
        }

        .logo {
            font-size: clamp(2rem, 5vw, 2.5rem);
            font-weight: 700;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-red) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-container {
            width: 100%;
            max-width: 300px;
        }

        .form-group {
            margin-bottom: 20px;
            width: 100%;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.2);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 136, 229, 0.4);
        }

        .btn-red {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--dark-red) 100%);
        }

        .btn-red:hover {
            box-shadow: 0 5px 15px rgba(229, 57, 53, 0.4);
        }

        .btn-google {
            background: white;
            color: #757575;
            border: 1px solid #ddd;
        }

        .btn-google:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--primary-blue);
            border: 1px solid var(--primary-blue);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.8rem;
            width: auto;
        }

        .toggle-form {
            margin-top: 20px;
            text-align: center;
            font-size: 0.9rem;
        }

        .toggle-form a {
            color: var(--primary-blue);
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            width: 100%;
        }

        .divider::before,
        .divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid var(--border-color);
        }

        .divider-text {
            padding: 0 15px;
            color: #aaa;
            font-size: 0.9rem;
        }

        /* Main App */
        #main-app {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-red) 100%);
            border-bottom: 1px solid var(--border-color);
            min-height: 60px;
        }

        .header-title {
            font-size: clamp(1rem, 4vw, 1.2rem);
            font-weight: 600;
            color: white;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: white;
            font-size: clamp(1rem, 4vw, 1.2rem);
            cursor: pointer;
        }

        /* Side Menu */
        #side-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background-color: var(--container-bg);
            z-index: 1000;
            transition: left 0.3s ease;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            border-right: 1px solid var(--border-color);
        }

        #side-menu.active {
            left: 0;
        }

        .menu-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-pic {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-red) 100%);
            color: white;
            overflow: hidden;
        }

        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .profile-info p {
            font-size: 0.8rem;
            color: #aaa;
        }

        .menu-items {
            list-style: none;
        }

        .menu-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }

        .menu-item:hover {
            color: var(--primary-blue);
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background-color: var(--container-bg);
            border-top: 1px solid var(--border-color);
            min-height: 60px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-color);
            text-decoration: none;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            justify-content: center;
        }

        .nav-item.active {
            color: var(--primary-blue);
        }

        .nav-item:hover {
            color: var(--primary-blue);
        }

        .nav-icon {
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            margin-bottom: 5px;
        }

        /* Contacts List */
        .contact-list {
            list-style: none;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .contact-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-red) 100%);
            color: white;
            overflow: hidden;
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .contact-status {
            font-size: 0.8rem;
            color: #aaa;
        }

        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--online-status);
            margin-right: 5px;
        }

        .unread-count {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--dark-red) 100%);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Friend Request Item */
        .request-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .request-actions {
            display: flex;
            gap: 10px;
        }

        /* Chat Screen */
        #chat-screen {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-red) 100%);
            border-bottom: 1px solid var(--border-color);
            min-height: 60px;
        }

        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            margin-right: 15px;
            cursor: pointer;
        }

        .chat-contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-red) 100%);
            color: white;
            overflow: hidden;
        }

        .chat-contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-contact-info {
            flex: 1;
        }

        .chat-contact-name {
            font-weight: 500;
            color: white;
        }

        .chat-contact-status {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .chat-actions {
            display: flex;
            gap: 15px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            background-color: var(--background-color);
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            position: relative;
            word-wrap: break-word;
        }

        .message.me {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: var(--bubble-text-me);
            border-bottom-right-radius: 5px;
        }

        .message.other {
            align-self: flex-start;
            background-color: var(--bubble-bg-other);
            color: var(--text-color);
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            text-align: right;
            margin-top: 5px;
        }

        .typing-indicator {
            align-self: flex-start;
            background-color: var(--bubble-bg-other);
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            font-style: italic;
            display: none;
        }

        .input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: var(--container-bg);
            min-height: 70px;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            font-size: 1rem;
            outline: none;
        }

        .message-input:focus {
            border-color: var(--primary-blue);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-left: 10px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Call Screen */
        #call-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            z-index: 2000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .call-info {
            text-align: center;
            margin-bottom: 30px;
        }

        .call-contact-name {
            font-size: clamp(1.2rem, 5vw, 1.5rem);
            font-weight: 600;
            margin-bottom: 10px;
            color: white;
        }

        .call-status {
            font-size: 1rem;
            color: #aaa;
        }

        .call-avatar {
            width: clamp(100px, 40vw, 150px);
            height: clamp(100px, 40vw, 150px);
            border-radius: 50%;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(2rem, 8vw, 3rem);
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-red) 100%);
            color: white;
            overflow: hidden;
        }

        .call-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .call-controls {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .call-btn {
            width: clamp(50px, 15vw, 60px);
            height: clamp(50px, 15vw, 60px);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .call-btn:hover {
            transform: scale(1.1);
        }

        .call-accept {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
        }

        .call-decline {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--dark-red) 100%);
            color: white;
        }

        .call-mute {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .call-end {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--dark-red) 100%);
            color: white;
        }

        .video-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #localVideo {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 120px;
            height: 160px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid var(--primary-blue);
        }

        /* Modal Overlays */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1500;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--container-bg);
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            max-height: 90%;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: clamp(1.1rem, 4vw, 1.3rem);
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-red) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Responsive Adjustments */
        @media (max-height: 700px) {
            #app-container {
                max-height: 100vh;
            }
            
            .header, .bottom-nav {
                min-height: 50px;
            }
            
            .input-area {
                min-height: 60px;
            }
        }

        @media (max-width: 450px) {
            #app-container {
                border-radius: 0;
                max-height: 100vh;
                max-width: 100%;
            }
            
            body {
                padding: 0;
            }
        }
        
        @media (max-width: 350px) {
            .contact-avatar, .chat-contact-avatar {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .contact-name, .chat-contact-name {
                font-size: 0.9rem;
            }
            
            .message {
                max-width: 90%;
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-blue);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--primary-blue);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        
        /* Landscape mode adjustments */
        @media (max-height: 500px) and (orientation: landscape) {
            #app-container {
                height: 100vh;
                max-height: 100vh;
            }
            
            .header, .bottom-nav {
                min-height: 40px;
                padding: 8px 15px;
            }
            
            .content-area {
                padding: 5px;
            }
            
            .contact-item {
                padding: 8px 15px;
            }
            
            .messages-container {
                padding: 8px;
            }
            
            .input-area {
                padding: 8px 15px;
                min-height: 50px;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Authentication Screens -->
        <div id="auth-screen" class="screen active">
            <div class="logo">BAN</div>
            <div class="form-container">
                <div id="login-form">
                    <button class="btn btn-google" id="google-login-btn">
                        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                            <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/>
                            <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/>
                            <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/>
                            <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/>
                        </svg>
                        Sign in with Google
                    </button>
                    
                    <div class="divider">
                        <span class="divider-text">or</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" placeholder="Enter your password">
                    </div>
                    <button class="btn" id="login-btn">Login</button>
                    <div class="toggle-form">
                        Don't have an account? <a id="show-signup">Sign Up</a>
                    </div>
                </div>
                
                <div id="signup-form" style="display: none;">
                    <button class="btn btn-google" id="google-signup-btn">
                        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                            <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/>
                            <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/>
                            <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/>
                            <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/>
                        </svg>
                        Sign up with Google
                    </button>
                    
                    <div class="divider">
                        <span class="divider-text">or</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="signup-email">Email</label>
                        <input type="email" id="signup-email" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password</label>
                        <input type="password" id="signup-password" placeholder="Create a password">
                    </div>
                    <button class="btn" id="signup-btn">Sign Up</button>
                    <div class="toggle-form">
                        Already have an account? <a id="show-login">Login</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Setup Screen -->
        <div id="profile-setup-screen" class="screen">
            <div class="logo">Complete Your Profile</div>
            <div class="form-container">
                <div class="form-group">
                    <label for="profile-name">Display Name (max 20 characters)</label>
                    <input type="text" id="profile-name" maxlength="20" placeholder="Your name">
                </div>
                <div class="form-group">
                    <label for="profile-bio">Bio (max 100 characters)</label>
                    <textarea id="profile-bio" maxlength="100" placeholder="Tell us about yourself"></textarea>
                </div>
                <div class="form-group">
                    <label for="profile-emoji">Profile Emoji (max 2 characters)</label>
                    <input type="text" id="profile-emoji" maxlength="2" placeholder="üòä">
                </div>
                <button class="btn" id="save-profile-btn">Save Profile</button>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app">
            <!-- Header -->
            <div class="header">
                <div class="header-title" id="current-screen-title">Chats</div>
                <div class="header-actions">
                    <button class="icon-btn" id="menu-toggle">‚ò∞</button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area" id="content-area">
                <!-- Home/Contacts Screen -->
                <div id="home-screen" class="screen active">
                    <ul class="contact-list" id="contact-list">
                        <!-- Contacts will be populated here -->
                    </ul>
                </div>

                <!-- Requests Screen -->
                <div id="requests-screen" class="screen">
                    <h3>Friend Requests</h3>
                    <ul class="contact-list" id="requests-list">
                        <!-- Requests will be populated here -->
                    </ul>
                </div>

                <!-- Calls Screen -->
                <div id="calls-screen" class="screen">
                    <h3>Recent Calls</h3>
                    <ul class="contact-list" id="calls-list">
                        <!-- Call history will be populated here -->
                    </ul>
                </div>
            </div>

            <!-- Chat Screen -->
            <div id="chat-screen">
                <div class="chat-header">
                    <button class="back-btn" id="back-from-chat">‚Üê</button>
                    <div class="chat-contact-avatar" id="chat-contact-avatar">üë§</div>
                    <div class="chat-contact-info">
                        <div class="chat-contact-name" id="chat-contact-name">Contact Name</div>
                        <div class="chat-contact-status" id="chat-contact-status">Online</div>
                    </div>
                    <div class="chat-actions">
                        <button class="icon-btn" id="voice-call-btn">üìû</button>
                        <button class="icon-btn" id="video-call-btn">üìπ</button>
                    </div>
                </div>
                <div class="messages-container" id="messages-container">
                    <div class="typing-indicator" id="typing-indicator">Contact is typing...</div>
                    <!-- Messages will be populated here -->
                </div>
                <div class="input-area">
                    <input type="text" class="message-input" id="message-input" placeholder="Type a message...">
                    <button class="send-btn" id="send-message-btn">‚û§</button>
                </div>
            </div>

            <!-- Bottom Navigation -->
            <div class="bottom-nav">
                <div class="nav-item active" data-screen="home-screen">
                    <div class="nav-icon">üí¨</div>
                    <span>Chats</span>
                </div>
                <div class="nav-item" data-screen="requests-screen">
                    <div class="nav-icon">üë•</div>
                    <span>Requests</span>
                </div>
                <div class="nav-item" data-screen="calls-screen">
                    <div class="nav-icon">üìû</div>
                    <span>Calls</span>
                </div>
            </div>
        </div>

        <!-- Side Menu -->
        <div id="side-menu">
            <div class="menu-header">
                <div class="profile-pic" id="menu-profile-pic">üë§</div>
                <div class="profile-info">
                    <h3 id="menu-profile-name">User Name</h3>
                    <p id="menu-profile-id">ban-0000</p>
                </div>
            </div>
            <ul class="menu-items">
                <li class="menu-item" id="edit-profile-menu">‚úèÔ∏è Edit Profile</li>
                <li class="menu-item" id="add-friend-menu">‚ûï Add Friend</li>
                <li class="menu-item" id="clear-chats-menu">üóëÔ∏è Clear Chats</li>
                <li class="menu-item" id="logout-menu">üö™ Logout</li>
            </ul>
        </div>

        <!-- Call Screen -->
        <div id="call-screen">
            <div id="voice-call-ui">
                <div class="call-avatar" id="call-avatar">üë§</div>
                <div class="call-info">
                    <div class="call-contact-name" id="call-contact-name">Contact Name</div>
                    <div class="call-status" id="call-status">Calling...</div>
                </div>
                <div class="call-controls">
                    <button class="call-btn call-mute" id="mute-btn">üîá</button>
                    <button class="call-btn call-accept" id="answer-call-btn">üìû</button>
                    <button class="call-btn call-decline" id="end-call-btn">‚úñ</button>
                </div>
            </div>
            <div id="video-call-ui" style="display: none;">
                <div class="video-container">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <video id="localVideo" autoplay playsinline muted></video>
                </div>
                <div class="call-controls">
                    <button class="call-btn call-mute" id="video-mute-btn">üîá</button>
                    <button class="call-btn call-decline" id="video-end-call-btn">‚úñ</button>
                </div>
            </div>
        </div>

        <!-- Modal Overlays -->
        <!-- Edit Profile Modal -->
        <div class="modal" id="edit-profile-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Edit Profile</div>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="form-group">
                    <label for="edit-profile-name">Display Name</label>
                    <input type="text" id="edit-profile-name" maxlength="20">
                </div>
                <div class="form-group">
                    <label for="edit-profile-bio">Bio</label>
                    <textarea id="edit-profile-bio" maxlength="100"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-profile-emoji">Profile Emoji</label>
                    <input type="text" id="edit-profile-emoji" maxlength="2">
                </div>
                <button class="btn" id="update-profile-btn">Update Profile</button>
            </div>
        </div>

        <!-- Add Friend Modal -->
        <div class="modal" id="add-friend-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Add Friend</div>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="form-group">
                    <label for="friend-id">Friend ID (e.g., ban-xxxx)</label>
                    <input type="text" id="friend-id" placeholder="Enter friend ID">
                </div>
                <button class="btn" id="send-request-btn">Send Request</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Firebase configuration - using your actual Firebase project config
        const firebaseConfig = {
            apiKey: "AIzaSyBVVRrhAejQKKrN0oj91KJqh38FpPhDyXk",
            authDomain: "ban-3f12a.firebaseapp.com",
            databaseURL: "https://ban-3f12a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ban-3f12a",
            storageBucket: "ban-3f12a.firebasestorage.app",
            messagingSenderId: "747731543226",
            appId: "1:747731543226:web:b689eef02a0d8ef00fce83"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Google Auth Provider
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // DOM Elements
        const authScreen = document.getElementById('auth-screen');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const googleSignupBtn = document.getElementById('google-signup-btn');
        
        const profileSetupScreen = document.getElementById('profile-setup-screen');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        
        const mainApp = document.getElementById('main-app');
        const menuToggle = document.getElementById('menu-toggle');
        const sideMenu = document.getElementById('side-menu');
        const contentArea = document.getElementById('content-area');
        const navItems = document.querySelectorAll('.nav-item');
        const currentScreenTitle = document.getElementById('current-screen-title');
        
        const chatScreen = document.getElementById('chat-screen');
        const backFromChat = document.getElementById('back-from-chat');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        
        const callScreen = document.getElementById('call-screen');
        const voiceCallUI = document.getElementById('voice-call-ui');
        const videoCallUI = document.getElementById('video-call-ui');
        const endCallBtn = document.getElementById('end-call-btn');
        const answerCallBtn = document.getElementById('answer-call-btn');
        const videoEndCallBtn = document.getElementById('video-end-call-btn');
        
        const editProfileModal = document.getElementById('edit-profile-modal');
        const addFriendModal = document.getElementById('add-friend-modal');
        const closeModals = document.querySelectorAll('.close-modal');
        const updateProfileBtn = document.getElementById('update-profile-btn');
        const sendRequestBtn = document.getElementById('send-request-btn');
        
        const toast = document.getElementById('toast');
        
        // Application State
        let currentUser = null;
        let currentChatId = null;
        let currentContact = null;
        let peerConnection = null;
        let localStream = null;
        let remoteStream = null;
        let isInCall = false;
        let callType = null; // 'voice' or 'video'
        let isCaller = false;
        let currentCallId = null;
        let ringtone = null;
        let callTimer = null;
        let callStartTime = null;

        // Utility Functions
        function generateUserId() {
            return 'ban-' + Math.floor(1000 + Math.random() * 9000);
        }

        function emojiToSVG(content) {
            // Create a simple SVG with the emoji/text
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
                <rect width="100" height="100" fill="#000"/>
                <text x="50" y="60" font-size="40" text-anchor="middle" fill="#fff">${content}</text>
            </svg>`;
            return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Firebase Functions
        function setupAuthStateListener() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    checkUserProfile(user.uid);
                } else {
                    currentUser = null;
                    showScreen(authScreen);
                }
            });
        }

        function checkUserProfile(uid) {
            const userRef = database.ref('users/' + uid);
            userRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // User profile exists, show main app
                    showMainApp();
                    setupUserPresence(uid);
                } else {
                    // User needs to set up profile
                    showScreen(profileSetupScreen);
                    
                    // If user signed in with Google, pre-fill profile form
                    if (currentUser.providerData && currentUser.providerData[0].providerId === 'google.com') {
                        const googleUser = currentUser.providerData[0];
                        document.getElementById('profile-name').value = googleUser.displayName || '';
                        document.getElementById('profile-emoji').value = 'üòä';
                        
                        // Use Google profile picture if available
                        if (googleUser.photoURL) {
                            // We'll store the photo URL in the database
                            // For now, just pre-fill the form
                        }
                    }
                }
            });
        }

        function setupUserPresence(uid) {
            // Set user as online
            const userStatusRef = database.ref('status/' + uid);
            const connectedRef = database.ref('.info/connected');
            
            connectedRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    userStatusRef.set({
                        online: true,
                        last_changed: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    // Set up onDisconnect to mark user as offline
                    userStatusRef.onDisconnect().set({
                        online: false,
                        last_changed: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });
        }

        function createUserProfile(uid, profileData) {
            const userRef = database.ref('users/' + uid);
            // Also create a mapping from userId to uid for friend search
            const userIdRef = database.ref('userIds/' + profileData.userId);
            
            return Promise.all([
                userRef.set({
                    ...profileData,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                }),
                userIdRef.set(uid)
            ]);
        }

        function updateUserProfile(uid, updates) {
            const userRef = database.ref('users/' + uid);
            return userRef.update(updates);
        }

        function getUserProfile(uid) {
            const userRef = database.ref('users/' + uid);
            return userRef.once('value').then(snapshot => snapshot.val());
        }

        function findUserByUserId(userId) {
            const userIdRef = database.ref('userIds/' + userId);
            return userIdRef.once('value').then(snapshot => {
                if (snapshot.exists()) {
                    return snapshot.val(); // Returns the UID
                }
                return null;
            });
        }

        function sendFriendRequest(targetUserId) {
            return findUserByUserId(targetUserId).then(targetUid => {
                if (!targetUid) {
                    throw new Error('User not found');
                }
                
                if (targetUid === currentUser.uid) {
                    throw new Error('You cannot send a friend request to yourself');
                }
                
                // Check if already friends
                const contactRef = database.ref('contacts/' + currentUser.uid + '/' + targetUid);
                return contactRef.once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        throw new Error('You are already friends with this user');
                    }
                    
                    // Check if request already exists
                    const requestRef = database.ref('requests/' + targetUid).orderByChild('from').equalTo(currentUser.uid);
                    return requestRef.once('value').then(snapshot => {
                        if (snapshot.exists()) {
                            throw new Error('Friend request already sent');
                        }
                        
                        // Send the request
                        const newRequestRef = database.ref('requests/' + targetUid).push();
                        return newRequestRef.set({
                            from: currentUser.uid,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                    });
                });
            });
        }

        function acceptFriendRequest(requestId, fromUserId) {
            const currentUserId = currentUser.uid;
            
            // Add to current user's contacts
            const userContactRef = database.ref('contacts/' + currentUserId + '/' + fromUserId);
            userContactRef.set(true);
            
            // Add to the other user's contacts
            const otherContactRef = database.ref('contacts/' + fromUserId + '/' + currentUserId);
            otherContactRef.set(true);
            
            // Remove the request
            const requestRef = database.ref('requests/' + currentUserId + '/' + requestId);
            return requestRef.remove();
        }

        function declineFriendRequest(requestId) {
            const currentUserId = currentUser.uid;
            const requestRef = database.ref('requests/' + currentUserId + '/' + requestId);
            return requestRef.remove();
        }

        function getOrCreateChatId(userId1, userId2) {
            // Create a consistent chat ID regardless of user order
            return [userId1, userId2].sort().join('_');
        }

        function sendMessage(chatId, messageText) {
            const messagesRef = database.ref('messages/' + chatId);
            return messagesRef.push({
                text: messageText,
                sender: currentUser.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function setupTypingIndicator(chatId) {
            const typingRef = database.ref('typing/' + chatId + '/' + currentUser.uid);
            
            messageInput.addEventListener('input', () => {
                typingRef.set(true);
                setTimeout(() => {
                    typingRef.set(false);
                }, 3000);
            });
            
            // Listen for other user's typing
            const otherUserId = currentChatId.replace(currentUser.uid, '').replace('_', '');
            const otherTypingRef = database.ref('typing/' + chatId + '/' + otherUserId);
            
            otherTypingRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    typingIndicator.style.display = 'block';
                } else {
                    typingIndicator.style.display = 'none';
                }
            });
        }

        // WebRTC Functions
        function createPeerConnection() {
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            };
            
            peerConnection = new RTCPeerConnection(configuration);
            
            // Add local stream to connection
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            // Handle incoming remote stream
            peerConnection.ontrack = (event) => {
                console.log('Received remote stream');
                remoteStream = event.streams[0];
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo) {
                    remoteVideo.srcObject = remoteStream;
                }
                // Update call status when connection is established
                if (isCaller) {
                    updateCallStatus('Connected');
                }
            };
            
            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    database.ref('calls/' + currentCallId + '/iceCandidates').push({
                        candidate: event.candidate,
                        from: currentUser.uid
                    });
                }
            };
            
            // Handle connection state changes
            peerConnection.onconnectionstatechange = (event) => {
                console.log('Connection state:', peerConnection.connectionState);
                switch(peerConnection.connectionState) {
                    case 'connected':
                        updateCallStatus('Connected');
                        startCallTimer();
                        break;
                    case 'disconnected':
                    case 'failed':
                        endCall();
                        break;
                }
            };
            
            return peerConnection;
        }

        async function startCall(contactId, type) {
            isCaller = true;
            callType = type;
            currentCallId = 'call_' + Date.now();
            
            try {
                // Get user media based on call type
                const mediaConstraints = {
                    audio: true,
                    video: type === 'video'
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
                
                if (type === 'video') {
                    const localVideo = document.getElementById('localVideo');
                    localVideo.srcObject = localStream;
                }
                
                // Create peer connection
                peerConnection = createPeerConnection();
                
                // Create offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Save offer to database
                await database.ref('calls/' + currentCallId).set({
                    offer: offer,
                    from: currentUser.uid,
                    to: contactId,
                    type: type,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Show call screen
                showCallScreen(type, true);
                
                // Listen for answer
                database.ref('calls/' + currentCallId + '/answer').on('value', async (snapshot) => {
                    const answer = snapshot.val();
                    if (answer && !peerConnection.remoteDescription) {
                        await peerConnection.setRemoteDescription(answer);
                    }
                });
                
                // Listen for ICE candidates from the other user
                database.ref('calls/' + currentCallId + '/iceCandidates').on('child_added', async (snapshot) => {
                    const candidateData = snapshot.val();
                    if (candidateData.from !== currentUser.uid) {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidateData.candidate));
                    }
                });
                
            } catch (error) {
                console.error('Error starting call:', error);
                showToast('Error starting call: ' + error.message);
                endCall();
            }
        }

        async function answerCall(callId, offer, type) {
            isCaller = false;
            callType = type;
            currentCallId = callId;
            
            try {
                // Get user media based on call type
                const mediaConstraints = {
                    audio: true,
                    video: type === 'video'
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
                
                if (type === 'video') {
                    const localVideo = document.getElementById('localVideo');
                    localVideo.srcObject = localStream;
                }
                
                // Create peer connection
                peerConnection = createPeerConnection();
                
                // Set remote offer
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                
                // Create and set local answer
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // Save answer to database
                await database.ref('calls/' + currentCallId + '/answer').set(answer);
                
                // Show call screen
                showCallScreen(type, false);
                
                // Listen for ICE candidates from the other user
                database.ref('calls/' + currentCallId + '/iceCandidates').on('child_added', async (snapshot) => {
                    const candidateData = snapshot.val();
                    if (candidateData.from !== currentUser.uid) {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidateData.candidate));
                    }
                });
                
            } catch (error) {
                console.error('Error answering call:', error);
                showToast('Error answering call: ' + error.message);
                endCall();
            }
        }

        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (currentCallId) {
                database.ref('calls/' + currentCallId).remove();
                currentCallId = null;
            }
            
            callScreen.style.display = 'none';
            isInCall = false;
            
            // Stop ringtone if playing
            if (ringtone) {
                ringtone.stop();
                ringtone = null;
            }
            
            // Stop call timer
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            // Log the call if it was connected
            if (callStartTime && currentContact && currentContact.id) {
                const duration = Math.floor((Date.now() - callStartTime) / 1000);
                logCall(currentContact.id, callType, duration);
                callStartTime = null;
            }
        }

        function updateCallStatus(status) {
            document.getElementById('call-status').textContent = status;
        }

        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(() => {
                const duration = Math.floor((Date.now() - callStartTime) / 1000);
                document.getElementById('call-status').textContent = `Call duration: ${formatDuration(duration)}`;
            }, 1000);
        }

        function logCall(contactId, type, duration) {
            if (!currentUser) return;
            
            const callLogRef = database.ref('callLogs/' + currentUser.uid);
            callLogRef.push({
                contactId: contactId,
                type: type,
                duration: duration,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function playRingtone() {
            // Create a simple ringtone using Tone.js
            try {
                ringtone = new Tone.Oscillator("C4", "sine").toDestination();
                ringtone.volume.value = -10;
                ringtone.start();
                
                // Stop after 30 seconds if not answered
                setTimeout(() => {
                    if (ringtone && isInCall) {
                        ringtone.stop();
                        ringtone = null;
                        // Auto decline if not answered
                        if (!isCaller) {
                            endCall();
                        }
                    }
                }, 30000);
            } catch (error) {
                console.error('Error playing ringtone:', error);
            }
        }

        // UI Functions
        function showScreen(screenElement) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show the requested screen
            screenElement.classList.add('active');
        }

        function showMainApp() {
            authScreen.classList.remove('active');
            profileSetupScreen.classList.remove('active');
            mainApp.style.display = 'flex';
            
            // Load user data
            loadUserData();
            loadContacts();
            loadFriendRequests();
            loadCallHistory();
            
            // Set up call listeners
            setupCallListeners();
        }

        function setupCallListeners() {
            // Listen for incoming calls
            database.ref('calls').orderByChild('to').equalTo(currentUser.uid).on('child_added', (snapshot) => {
                const callData = snapshot.val();
                const callId = snapshot.key;
                
                // Check if this call is for the current user and we're not already in a call
                if (callData.to === currentUser.uid && !callData.answer && !isInCall) {
                    // Get caller info
                    getUserProfile(callData.from).then(profile => {
                        if (profile) {
                            currentContact = {
                                id: callData.from,
                                name: profile.name,
                                emoji: profile.emoji
                            };
                            
                            // Show incoming call UI
                            showCallScreen(callData.type, false);
                            
                            // Store the call data for answering
                            window.pendingCall = {
                                id: callId,
                                offer: callData.offer,
                                type: callData.type
                            };
                        }
                    });
                }
            });
        }

        function loadUserData() {
            if (!currentUser) return;
            
            getUserProfile(currentUser.uid).then(profile => {
                if (profile) {
                    // Update menu with user data
                    document.getElementById('menu-profile-name').textContent = profile.name;
                    document.getElementById('menu-profile-id').textContent = profile.userId;
                    
                    // Update profile picture - use Google photo if available
                    const profilePic = document.getElementById('menu-profile-pic');
                    if (currentUser.photoURL) {
                        profilePic.innerHTML = `<img src="${currentUser.photoURL}" alt="Profile">`;
                    } else {
                        profilePic.textContent = profile.emoji;
                    }
                    
                    // Update edit profile form
                    document.getElementById('edit-profile-name').value = profile.name;
                    document.getElementById('edit-profile-bio').value = profile.bio || '';
                    document.getElementById('edit-profile-emoji').value = profile.emoji;
                }
            });
        }

        function loadContacts() {
            if (!currentUser) return;
            
            const contactsRef = database.ref('contacts/' + currentUser.uid);
            contactsRef.on('value', (snapshot) => {
                const contacts = snapshot.val();
                const contactList = document.getElementById('contact-list');
                contactList.innerHTML = '';
                
                if (!contacts) {
                    contactList.innerHTML = '<li class="contact-item"><div class="contact-info"><div class="contact-name">No contacts yet</div></div></li>';
                    return;
                }
                
                Object.keys(contacts).forEach(contactUid => {
                    getUserProfile(contactUid).then(profile => {
                        if (profile) {
                            const contactItem = document.createElement('li');
                            contactItem.className = 'contact-item';
                            contactItem.dataset.contactId = contactUid;
                            
                            // Create avatar with Google photo if available
                            let avatarHTML = profile.emoji;
                            // In a real app, we would store the photo URL in the user profile
                            
                            contactItem.innerHTML = `
                                <div class="contact-avatar">${avatarHTML}</div>
                                <div class="contact-info">
                                    <div class="contact-name">${profile.name}</div>
                                    <div class="contact-status">
                                        <span class="online-indicator"></span>Online
                                    </div>
                                </div>
                                <div class="unread-count">0</div>
                            `;
                            
                            contactItem.addEventListener('click', () => openChat({
                                id: contactUid,
                                name: profile.name,
                                emoji: profile.emoji,
                                online: true
                            }));
                            contactList.appendChild(contactItem);
                        }
                    });
                });
            });
        }

        function loadFriendRequests() {
            if (!currentUser) return;
            
            const requestsRef = database.ref('requests/' + currentUser.uid);
            requestsRef.on('value', (snapshot) => {
                const requests = snapshot.val();
                const requestsList = document.getElementById('requests-list');
                requestsList.innerHTML = '';
                
                if (!requests) {
                    requestsList.innerHTML = '<li class="request-item"><div class="contact-info"><div class="contact-name">No friend requests</div></div></li>';
                    return;
                }
                
                Object.keys(requests).forEach(requestId => {
                    const request = requests[requestId];
                    getUserProfile(request.from).then(profile => {
                        if (profile) {
                            const requestItem = document.createElement('li');
                            requestItem.className = 'request-item';
                            
                            requestItem.innerHTML = `
                                <div class="contact-avatar">${profile.emoji}</div>
                                <div class="contact-info">
                                    <div class="contact-name">${profile.name}</div>
                                    <div class="contact-status">Sent ${formatTime(request.timestamp)}</div>
                                </div>
                                <div class="request-actions">
                                    <button class="btn btn-small accept-request" data-request-id="${requestId}" data-from-uid="${request.from}">Accept</button>
                                    <button class="btn btn-small btn-red decline-request" data-request-id="${requestId}">Decline</button>
                                </div>
                            `;
                            
                            requestsList.appendChild(requestItem);
                        }
                    });
                });
                
                // Add event listeners for accept/decline buttons
                setTimeout(() => {
                    document.querySelectorAll('.accept-request').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const requestId = e.target.dataset.requestId;
                            const fromUid = e.target.dataset.fromUid;
                            acceptFriendRequest(requestId, fromUid)
                                .then(() => {
                                    showToast('Friend request accepted');
                                })
                                .catch(error => {
                                    showToast('Error accepting request: ' + error.message);
                                });
                        });
                    });
                    
                    document.querySelectorAll('.decline-request').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const requestId = e.target.dataset.requestId;
                            declineFriendRequest(requestId)
                                .then(() => {
                                    showToast('Friend request declined');
                                })
                                .catch(error => {
                                    showToast('Error declining request: ' + error.message);
                                });
                        });
                    });
                }, 100);
            });
        }

        function loadCallHistory() {
            // In a real app, we would load from Firebase
            // For this demo, we'll create some mock call history
            const callsList = document.getElementById('calls-list');
            callsList.innerHTML = '';
            
            const mockCalls = [
                { id: 'call1', contact: { name: 'Alex Johnson', emoji: 'üë®' }, type: 'voice', duration: '5:32', timestamp: Date.now() - 86400000, missed: false },
                { id: 'call2', contact: { name: 'Sam Smith', emoji: 'üë©' }, type: 'video', duration: '12:45', timestamp: Date.now() - 172800000, missed: false },
                { id: 'call3', contact: { name: 'Taylor Swift', emoji: 'üé§' }, type: 'voice', duration: '0:00', timestamp: Date.now() - 3600000, missed: true }
            ];
            
            mockCalls.forEach(call => {
                const callItem = document.createElement('li');
                callItem.className = 'contact-item';
                
                callItem.innerHTML = `
                    <div class="contact-avatar">${call.contact.emoji}</div>
                    <div class="contact-info">
                        <div class="contact-name">${call.contact.name}</div>
                        <div class="contact-status">
                            ${call.missed ? 'Missed ' : ''}${call.type === 'video' ? 'Video' : 'Voice'} call ‚Ä¢ ${formatTime(call.timestamp)}
                            ${!call.missed && call.duration !== '0:00' ? ` ‚Ä¢ ${call.duration}` : ''}
                        </div>
                    </div>
                    <button class="icon-btn call-back-btn">üìû</button>
                `;
                
                callsList.appendChild(callItem);
            });
        }

        function openChat(contact) {
            currentContact = contact;
            currentChatId = getOrCreateChatId(currentUser.uid, contact.id);
            
            // Update chat header
            document.getElementById('chat-contact-name').textContent = contact.name;
            document.getElementById('chat-contact-avatar').textContent = contact.emoji;
            document.getElementById('chat-contact-status').textContent = contact.online ? 'Online' : 'Offline';
            
            // Show chat screen
            chatScreen.style.display = 'flex';
            contentArea.style.display = 'none';
            document.querySelector('.bottom-nav').style.display = 'none';
            
            // Load messages
            loadMessages(currentChatId);
            
            // Setup typing indicator
            setupTypingIndicator(currentChatId);
        }

        function loadMessages(chatId) {
            // In a real app, we would load from Firebase
            // For this demo, we'll create some mock messages
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            
            const mockMessages = [
                { id: 'msg1', text: 'Hey there! How are you?', sender: currentContact.id, timestamp: Date.now() - 3600000 },
                { id: 'msg2', text: 'I\'m doing great! Just working on this new app.', sender: currentUser.uid, timestamp: Date.now() - 3500000 },
                { id: 'msg3', text: 'That sounds interesting. Tell me more about it.', sender: currentContact.id, timestamp: Date.now() - 3400000 },
                { id: 'msg4', text: 'It\'s a real-time chat app with voice and video calling features.', sender: currentUser.uid, timestamp: Date.now() - 3300000 },
                { id: 'msg5', text: 'Wow, that\'s cool! Can I try it out?', sender: currentContact.id, timestamp: Date.now() - 3200000 }
            ];
            
            mockMessages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.sender === currentUser.uid ? 'me' : 'other'}`;
                
                messageElement.innerHTML = `
                    <div class="message-text">${message.text}</div>
                    <div class="message-time">${formatTime(message.timestamp)}</div>
                `;
                
                messagesContainer.appendChild(messageElement);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showCallScreen(type, caller = true) {
            isCaller = caller;
            callScreen.style.display = 'flex';
            isInCall = true;
            
            // Update call info
            document.getElementById('call-contact-name').textContent = currentContact.name;
            document.getElementById('call-avatar').textContent = currentContact.emoji;
            
            if (type === 'voice') {
                voiceCallUI.style.display = 'block';
                videoCallUI.style.display = 'none';
                
                // Show/hide appropriate buttons
                if (isCaller) {
                    document.getElementById('answer-call-btn').style.display = 'none';
                    document.getElementById('call-status').textContent = 'Calling...';
                } else {
                    document.getElementById('answer-call-btn').style.display = 'flex';
                    document.getElementById('call-status').textContent = 'Incoming call...';
                }
            } else {
                voiceCallUI.style.display = 'none';
                videoCallUI.style.display = 'block';
                document.getElementById('call-status').textContent = isCaller ? 'Calling...' : 'Incoming call...';
            }
            
            // If we're receiving a call, play ringtone
            if (!isCaller) {
                playRingtone();
            }
        }

        // Google Sign-In Function
        function signInWithGoogle() {
            auth.signInWithPopup(googleProvider)
                .then((result) => {
                    // This gives you a Google Access Token
                    const credential = result.credential;
                    const token = credential.accessToken;
                    // The signed-in user info
                    const user = result.user;
                    
                    showToast('Signed in with Google successfully!');
                })
                .catch((error) => {
                    // Handle Errors here
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    showToast('Error signing in with Google: ' + errorMessage);
                });
        }

        // Event Listeners
        // Auth events
        showSignup.addEventListener('click', () => {
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
        });

        showLogin.addEventListener('click', () => {
            signupForm.style.display = 'none';
            loginForm.style.display = 'block';
        });

        loginBtn.addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // User logged in successfully
                    // Auth state listener will handle the rest
                })
                .catch((error) => {
                    console.error(error);
                    showToast('Login failed: ' + error.message);
                });
        });

        signupBtn.addEventListener('click', () => {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // User created successfully
                    // Will be directed to profile setup by auth state listener
                })
                .catch((error) => {
                    console.error(error);
                    showToast('Sign up failed: ' + error.message);
                });
        });

        // Google Sign-In buttons
        googleLoginBtn.addEventListener('click', signInWithGoogle);
        googleSignupBtn.addEventListener('click', signInWithGoogle);

        saveProfileBtn.addEventListener('click', () => {
            const name = document.getElementById('profile-name').value;
            const bio = document.getElementById('profile-bio').value;
            const emoji = document.getElementById('profile-emoji').value;
            
            if (!name || !emoji) {
                showToast('Please fill in all required fields');
                return;
            }
            
            const profileData = {
                name: name,
                bio: bio,
                emoji: emoji,
                dpUrl: emojiToSVG(emoji),
                userId: generateUserId()
            };
            
            createUserProfile(currentUser.uid, profileData)
                .then(() => {
                    showMainApp();
                })
                .catch((error) => {
                    console.error(error);
                    showToast('Error saving profile: ' + error.message);
                });
        });

        // Main app events
        menuToggle.addEventListener('click', () => {
            sideMenu.classList.toggle('active');
        });

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                // Update active nav item
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                
                // Show the corresponding screen
                const screenId = item.dataset.screen;
                document.querySelectorAll('#content-area .screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');
                
                // Update header title
                currentScreenTitle.textContent = item.querySelector('span').textContent;
            });
        });

        backFromChat.addEventListener('click', () => {
            chatScreen.style.display = 'none';
            contentArea.style.display = 'block';
            document.querySelector('.bottom-nav').style.display = 'flex';
        });

        sendMessageBtn.addEventListener('click', () => {
            const messageText = messageInput.value.trim();
            if (messageText && currentChatId) {
                sendMessage(currentChatId, messageText)
                    .then(() => {
                        messageInput.value = '';
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                    });
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessageBtn.click();
            }
        });

        // Call events
        document.getElementById('voice-call-btn').addEventListener('click', () => {
            if (currentContact) {
                startCall(currentContact.id, 'voice');
            }
        });

        document.getElementById('video-call-btn').addEventListener('click', () => {
            if (currentContact) {
                startCall(currentContact.id, 'video');
            }
        });

        endCallBtn.addEventListener('click', endCall);
        videoEndCallBtn.addEventListener('click', endCall);
        
        answerCallBtn.addEventListener('click', () => {
            if (window.pendingCall) {
                answerCall(window.pendingCall.id, window.pendingCall.offer, window.pendingCall.type);
                window.pendingCall = null;
            }
        });

        // Modal events
        document.getElementById('edit-profile-menu').addEventListener('click', () => {
            editProfileModal.classList.add('active');
            sideMenu.classList.remove('active');
        });

        document.getElementById('add-friend-menu').addEventListener('click', () => {
            addFriendModal.classList.add('active');
            sideMenu.classList.remove('active');
        });

        document.getElementById('logout-menu').addEventListener('click', () => {
            auth.signOut();
        });

        closeModals.forEach(btn => {
            btn.addEventListener('click', () => {
                editProfileModal.classList.remove('active');
                addFriendModal.classList.remove('active');
            });
        });

        updateProfileBtn.addEventListener('click', () => {
            const name = document.getElementById('edit-profile-name').value;
            const bio = document.getElementById('edit-profile-bio').value;
            const emoji = document.getElementById('edit-profile-emoji').value;
            
            if (!name || !emoji) {
                showToast('Please fill in all required fields');
                return;
            }
            
            const updates = {
                name: name,
                bio: bio,
                emoji: emoji,
                dpUrl: emojiToSVG(emoji)
            };
            
            updateUserProfile(currentUser.uid, updates)
                .then(() => {
                    editProfileModal.classList.remove('active');
                    loadUserData();
                })
                .catch(error => {
                    console.error(error);
                    showToast('Error updating profile: ' + error.message);
                });
        });

        sendRequestBtn.addEventListener('click', () => {
            const friendId = document.getElementById('friend-id').value.trim();
            
            if (!friendId) {
                showToast('Please enter a friend ID');
                return;
            }
            
            sendFriendRequest(friendId)
                .then(() => {
                    addFriendModal.classList.remove('active');
                    document.getElementById('friend-id').value = '';
                    showToast('Friend request sent successfully!');
                })
                .catch(error => {
                    showToast('Error: ' + error.message);
                });
        });

        if (new URLSearchParams(location.search).get('test') === '1') {
            const results = [];
            function assert(name, condition) { results.push({ name, pass: !!condition }); }
            assert('emojiToSVG returns data uri', emojiToSVG('üòä').startsWith('data:image/svg+xml'));
            assert('getOrCreateChatId symmetric', getOrCreateChatId('b','a') === 'a_b');
            assert('formatDuration 125', formatDuration(125) === '2:05');
            assert('generateUserId prefix', /^ban-\d{4}$/.test(generateUserId()));
            const failed = results.filter(r => !r.pass);
            console.log('Test results', results);
            showToast(failed.length === 0 ? 'All tests passed' : ('Tests failed: ' + failed.map(r => r.name).join(', ')), 5000);
        }

        setupAuthStateListener();
    </script>
</body>
</html>
