<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAN</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root {
            --primary-color: #00A878;
            --background-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --bubble-bg-me: #00A878;
            --bubble-text-me: #121212;
            --border-color: #333;
            --online-status: #00A878;
            --offline-status: #666;
            --error-color: #ff5252;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        #app-container {
            width: 100%;
            max-width: 400px;
            height: 100vh;
            max-height: 800px;
            background-color: var(--container-bg);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        /* Auth Screens */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            padding: 20px;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .screen.active {
            display: flex;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 30px;
            color: var(--primary-color);
        }

        .form-container {
            width: 100%;
            max-width: 300px;
        }

        .form-group {
            margin-bottom: 20px;
            width: 100%;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            background-color: var(--primary-color);
            color: var(--bubble-text-me);
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .toggle-form {
            margin-top: 20px;
            text-align: center;
            font-size: 0.9rem;
        }

        .toggle-form a {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
        }

        /* Main App */
        #main-app {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--container-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Side Menu */
        #side-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background-color: var(--container-bg);
            z-index: 1000;
            transition: left 0.3s ease;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
        }

        #side-menu.active {
            left: 0;
        }

        .menu-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-pic {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            background-color: #000;
            color: white;
        }

        .profile-info h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .profile-info p {
            font-size: 0.8rem;
            color: #aaa;
        }

        .menu-items {
            list-style: none;
        }

        .menu-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            background-color: var(--container-bg);
            border-top: 1px solid var(--border-color);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-color);
            text-decoration: none;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        /* Contacts List */
        .contact-list {
            list-style: none;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .contact-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            background-color: #000;
            color: white;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .contact-status {
            font-size: 0.8rem;
            color: #aaa;
        }

        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--online-status);
            margin-right: 5px;
        }

        .unread-count {
            background-color: var(--primary-color);
            color: var(--bubble-text-me);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Chat Screen */
        #chat-screen {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: var(--container-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            margin-right: 15px;
            cursor: pointer;
        }

        .chat-contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
            background-color: #000;
            color: white;
        }

        .chat-contact-info {
            flex: 1;
        }

        .chat-contact-name {
            font-weight: 500;
        }

        .chat-contact-status {
            font-size: 0.7rem;
            color: #aaa;
        }

        .chat-actions {
            display: flex;
            gap: 15px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            position: relative;
            word-wrap: break-word;
        }

        .message.me {
            align-self: flex-end;
            background-color: var(--bubble-bg-me);
            color: var(--bubble-text-me);
            border-bottom-right-radius: 5px;
        }

        .message.other {
            align-self: flex-start;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            text-align: right;
            margin-top: 5px;
        }

        .typing-indicator {
            align-self: flex-start;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            font-style: italic;
            display: none;
        }

        .input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: var(--container-bg);
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            font-size: 1rem;
            outline: none;
        }

        .send-btn {
            background-color: var(--primary-color);
            color: var(--bubble-text-me);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-left: 10px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Call Screen */
        #call-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            z-index: 2000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .call-info {
            text-align: center;
            margin-bottom: 30px;
        }

        .call-contact-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .call-status {
            font-size: 1rem;
            color: #aaa;
        }

        .call-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            background-color: #000;
            color: white;
        }

        .call-controls {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            border: none;
        }

        .call-accept {
            background-color: var(--primary-color);
            color: white;
        }

        .call-decline {
            background-color: var(--error-color);
            color: white;
        }

        .call-mute {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .call-end {
            background-color: var(--error-color);
            color: white;
        }

        .video-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #localVideo {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 120px;
            height: 160px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid var(--primary-color);
        }

        /* Modal Overlays */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1500;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--container-bg);
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            max-height: 90%;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Responsive Adjustments */
        @media (max-height: 700px) {
            #app-container {
                max-height: 600px;
            }
        }

        @media (max-width: 450px) {
            #app-container {
                border-radius: 0;
                max-height: 100vh;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Authentication Screens -->
        <div id="auth-screen" class="screen active">
            <div class="logo">BAN</div>
            <div class="form-container">
                <div id="login-form">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" placeholder="Enter your password">
                    </div>
                    <button class="btn" id="login-btn">Login</button>
                    <div class="toggle-form">
                        Don't have an account? <a id="show-signup">Sign Up</a>
                    </div>
                </div>
                
                <div id="signup-form" style="display: none;">
                    <div class="form-group">
                        <label for="signup-email">Email</label>
                        <input type="email" id="signup-email" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password</label>
                        <input type="password" id="signup-password" placeholder="Create a password">
                    </div>
                    <button class="btn" id="signup-btn">Sign Up</button>
                    <div class="toggle-form">
                        Already have an account? <a id="show-login">Login</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Setup Screen -->
        <div id="profile-setup-screen" class="screen">
            <div class="logo">Complete Your Profile</div>
            <div class="form-container">
                <div class="form-group">
                    <label for="profile-name">Display Name (max 20 characters)</label>
                    <input type="text" id="profile-name" maxlength="20" placeholder="Your name">
                </div>
                <div class="form-group">
                    <label for="profile-bio">Bio (max 100 characters)</label>
                    <textarea id="profile-bio" maxlength="100" placeholder="Tell us about yourself"></textarea>
                </div>
                <div class="form-group">
                    <label for="profile-emoji">Profile Emoji (max 2 characters)</label>
                    <input type="text" id="profile-emoji" maxlength="2" placeholder="üòä">
                </div>
                <button class="btn" id="save-profile-btn">Save Profile</button>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app">
            <!-- Header -->
            <div class="header">
                <div class="header-title" id="current-screen-title">Chats</div>
                <div class="header-actions">
                    <button class="icon-btn" id="menu-toggle">‚ò∞</button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area" id="content-area">
                <!-- Home/Contacts Screen -->
                <div id="home-screen" class="screen active">
                    <ul class="contact-list" id="contact-list">
                        <!-- Contacts will be populated here -->
                    </ul>
                </div>

                <!-- Requests Screen -->
                <div id="requests-screen" class="screen">
                    <h3>Friend Requests</h3>
                    <ul class="contact-list" id="requests-list">
                        <!-- Requests will be populated here -->
                    </ul>
                </div>

                <!-- Calls Screen -->
                <div id="calls-screen" class="screen">
                    <h3>Recent Calls</h3>
                    <ul class="contact-list" id="calls-list">
                        <!-- Call history will be populated here -->
                    </ul>
                </div>
            </div>

            <!-- Chat Screen -->
            <div id="chat-screen">
                <div class="chat-header">
                    <button class="back-btn" id="back-from-chat">‚Üê</button>
                    <div class="chat-contact-avatar" id="chat-contact-avatar">üë§</div>
                    <div class="chat-contact-info">
                        <div class="chat-contact-name" id="chat-contact-name">Contact Name</div>
                        <div class="chat-contact-status" id="chat-contact-status">Online</div>
                    </div>
                    <div class="chat-actions">
                        <button class="icon-btn" id="voice-call-btn">üìû</button>
                        <button class="icon-btn" id="video-call-btn">üìπ</button>
                    </div>
                </div>
                <div class="messages-container" id="messages-container">
                    <div class="typing-indicator" id="typing-indicator">Contact is typing...</div>
                    <!-- Messages will be populated here -->
                </div>
                <div class="input-area">
                    <input type="text" class="message-input" id="message-input" placeholder="Type a message...">
                    <button class="send-btn" id="send-message-btn">‚û§</button>
                </div>
            </div>

            <!-- Bottom Navigation -->
            <div class="bottom-nav">
                <div class="nav-item active" data-screen="home-screen">
                    <div class="nav-icon">üí¨</div>
                    <span>Chats</span>
                </div>
                <div class="nav-item" data-screen="requests-screen">
                    <div class="nav-icon">üë•</div>
                    <span>Requests</span>
                </div>
                <div class="nav-item" data-screen="calls-screen">
                    <div class="nav-icon">üìû</div>
                    <span>Calls</span>
                </div>
            </div>
        </div>

        <!-- Side Menu -->
        <div id="side-menu">
            <div class="menu-header">
                <div class="profile-pic" id="menu-profile-pic">üë§</div>
                <div class="profile-info">
                    <h3 id="menu-profile-name">User Name</h3>
                    <p id="menu-profile-id">ban-0000</p>
                </div>
            </div>
            <ul class="menu-items">
                <li class="menu-item" id="edit-profile-menu">‚úèÔ∏è Edit Profile</li>
                <li class="menu-item" id="add-friend-menu">‚ûï Add Friend</li>
                <li class="menu-item" id="clear-chats-menu">üóëÔ∏è Clear Chats</li>
                <li class="menu-item" id="logout-menu">üö™ Logout</li>
            </ul>
        </div>

        <!-- Call Screen -->
        <div id="call-screen">
            <div id="voice-call-ui">
                <div class="call-avatar" id="call-avatar">üë§</div>
                <div class="call-info">
                    <div class="call-contact-name" id="call-contact-name">Contact Name</div>
                    <div class="call-status" id="call-status">Calling...</div>
                </div>
                <div class="call-controls">
                    <button class="call-btn call-mute" id="mute-btn">üîá</button>
                    <button class="call-btn call-decline" id="end-call-btn">üìû</button>
                </div>
            </div>
            <div id="video-call-ui" style="display: none;">
                <div class="video-container">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <video id="localVideo" autoplay playsinline muted></video>
                </div>
                <div class="call-controls">
                    <button class="call-btn call-mute" id="video-mute-btn">üîá</button>
                    <button class="call-btn call-decline" id="video-end-call-btn">üìû</button>
                </div>
            </div>
        </div>

        <!-- Modal Overlays -->
        <!-- Edit Profile Modal -->
        <div class="modal" id="edit-profile-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Edit Profile</div>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="form-group">
                    <label for="edit-profile-name">Display Name</label>
                    <input type="text" id="edit-profile-name" maxlength="20">
                </div>
                <div class="form-group">
                    <label for="edit-profile-bio">Bio</label>
                    <textarea id="edit-profile-bio" maxlength="100"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-profile-emoji">Profile Emoji</label>
                    <input type="text" id="edit-profile-emoji" maxlength="2">
                </div>
                <button class="btn" id="update-profile-btn">Update Profile</button>
            </div>
        </div>

        <!-- Add Friend Modal -->
        <div class="modal" id="add-friend-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Add Friend</div>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="form-group">
                    <label for="friend-id">Friend ID (e.g., ban-xxxx)</label>
                    <input type="text" id="friend-id" placeholder="Enter friend ID">
                </div>
                <button class="btn" id="send-request-btn">Send Request</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase configuration - using your actual Firebase project config
        const firebaseConfig = {
            apiKey: "AIzaSyBVVRrhAejQKKrN0oj91KJqh38FpPhDyXk",
            authDomain: "ban-3f12a.firebaseapp.com",
            databaseURL: "https://ban-3f12a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ban-3f12a",
            storageBucket: "ban-3f12a.firebasestorage.app",
            messagingSenderId: "747731543226",
            appId: "1:747731543226:web:b689eef02a0d8ef00fce83"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // DOM Elements
        const authScreen = document.getElementById('auth-screen');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        
        const profileSetupScreen = document.getElementById('profile-setup-screen');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        
        const mainApp = document.getElementById('main-app');
        const menuToggle = document.getElementById('menu-toggle');
        const sideMenu = document.getElementById('side-menu');
        const contentArea = document.getElementById('content-area');
        const navItems = document.querySelectorAll('.nav-item');
        const currentScreenTitle = document.getElementById('current-screen-title');
        
        const chatScreen = document.getElementById('chat-screen');
        const backFromChat = document.getElementById('back-from-chat');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        
        const callScreen = document.getElementById('call-screen');
        const voiceCallUI = document.getElementById('voice-call-ui');
        const videoCallUI = document.getElementById('video-call-ui');
        const endCallBtn = document.getElementById('end-call-btn');
        const videoEndCallBtn = document.getElementById('video-end-call-btn');
        
        const editProfileModal = document.getElementById('edit-profile-modal');
        const addFriendModal = document.getElementById('add-friend-modal');
        const closeModals = document.querySelectorAll('.close-modal');
        const updateProfileBtn = document.getElementById('update-profile-btn');
        const sendRequestBtn = document.getElementById('send-request-btn');
        
        // Application State
        let currentUser = null;
        let currentChatId = null;
        let currentContact = null;
        let peerConnection = null;
        let localStream = null;
        let isInCall = false;
        let callType = null; // 'voice' or 'video'
        let isCaller = false;
        let currentCallId = null;
        let ringtone = null;

        // Utility Functions
        function generateUserId() {
            return 'ban-' + Math.floor(1000 + Math.random() * 9000);
        }

        function emojiToSVG(content) {
            // Create a simple SVG with the emoji/text
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
                <rect width="100" height="100" fill="#000"/>
                <text x="50" y="60" font-size="40" text-anchor="middle" fill="#fff">${content}</text>
            </svg>`;
            return 'data:image/svg+xml;base64,' + btoa(svg);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Firebase Functions
        function setupAuthStateListener() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    checkUserProfile(user.uid);
                } else {
                    currentUser = null;
                    showScreen(authScreen);
                }
            });
        }

        function checkUserProfile(uid) {
            const userRef = database.ref('users/' + uid);
            userRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // User profile exists, show main app
                    showMainApp();
                    setupUserPresence(uid);
                } else {
                    // User needs to set up profile
                    showScreen(profileSetupScreen);
                }
            });
        }

        function setupUserPresence(uid) {
            // Set user as online
            const userStatusRef = database.ref('status/' + uid);
            const connectedRef = database.ref('.info/connected');
            
            connectedRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    userStatusRef.set({
                        online: true,
                        last_changed: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    // Set up onDisconnect to mark user as offline
                    userStatusRef.onDisconnect().set({
                        online: false,
                        last_changed: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });
        }

        function createUserProfile(uid, profileData) {
            const userRef = database.ref('users/' + uid);
            return userRef.set({
                ...profileData,
                userId: generateUserId(),
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function updateUserProfile(uid, updates) {
            const userRef = database.ref('users/' + uid);
            return userRef.update(updates);
        }

        function getUserProfile(uid) {
            const userRef = database.ref('users/' + uid);
            return userRef.once('value').then(snapshot => snapshot.val());
        }

        function sendFriendRequest(targetUserId) {
            // In a real app, we would search for the user by their public ID
            // For this demo, we'll simulate finding a user
            const currentUserId = currentUser.uid;
            const requestRef = database.ref('requests/' + targetUserId);
            
            return requestRef.push({
                from: currentUserId,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function acceptFriendRequest(requestId, fromUserId) {
            const currentUserId = currentUser.uid;
            
            // Add to current user's contacts
            const userContactRef = database.ref('contacts/' + currentUserId + '/' + fromUserId);
            userContactRef.set(true);
            
            // Add to the other user's contacts
            const otherContactRef = database.ref('contacts/' + fromUserId + '/' + currentUserId);
            otherContactRef.set(true);
            
            // Remove the request
            const requestRef = database.ref('requests/' + currentUserId + '/' + requestId);
            return requestRef.remove();
        }

        function getOrCreateChatId(userId1, userId2) {
            // Create a consistent chat ID regardless of user order
            return [userId1, userId2].sort().join('_');
        }

        function sendMessage(chatId, messageText) {
            const messagesRef = database.ref('messages/' + chatId);
            return messagesRef.push({
                text: messageText,
                sender: currentUser.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function setupTypingIndicator(chatId) {
            const typingRef = database.ref('typing/' + chatId + '/' + currentUser.uid);
            
            messageInput.addEventListener('input', () => {
                typingRef.set(true);
                setTimeout(() => {
                    typingRef.set(false);
                }, 3000);
            });
            
            // Listen for other user's typing
            const otherUserId = currentChatId.replace(currentUser.uid, '').replace('_', '');
            const otherTypingRef = database.ref('typing/' + chatId + '/' + otherUserId);
            
            otherTypingRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    typingIndicator.style.display = 'block';
                } else {
                    typingIndicator.style.display = 'none';
                }
            });
        }

        // WebRTC Functions
        function createPeerConnection() {
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            };
            
            peerConnection = new RTCPeerConnection(configuration);
            
            // Add local stream to connection
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            // Handle incoming remote stream
            peerConnection.ontrack = (event) => {
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };
            
            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    database.ref('calls/' + currentCallId + '/iceCandidates').push({
                        candidate: event.candidate,
                        from: currentUser.uid
                    });
                }
            };
            
            return peerConnection;
        }

        async function startCall(contactId, type) {
            isCaller = true;
            callType = type;
            currentCallId = Date.now().toString();
            
            try {
                // Get user media based on call type
                const mediaConstraints = {
                    audio: true,
                    video: type === 'video'
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
                
                if (type === 'video') {
                    const localVideo = document.getElementById('localVideo');
                    localVideo.srcObject = localStream;
                }
                
                // Create peer connection
                peerConnection = createPeerConnection();
                
                // Create offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Save offer to database
                await database.ref('calls/' + currentCallId).set({
                    offer: offer,
                    from: currentUser.uid,
                    to: contactId,
                    type: type,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Show call screen
                showCallScreen(type);
                
                // Listen for answer
                database.ref('calls/' + currentCallId + '/answer').on('value', async (snapshot) => {
                    const answer = snapshot.val();
                    if (answer && !peerConnection.remoteDescription) {
                        await peerConnection.setRemoteDescription(answer);
                    }
                });
                
                // Listen for ICE candidates from the other user
                database.ref('calls/' + currentCallId + '/iceCandidates').on('child_added', async (snapshot) => {
                    const candidateData = snapshot.val();
                    if (candidateData.from !== currentUser.uid) {
                        await peerConnection.addIceCandidate(candidateData.candidate);
                    }
                });
                
            } catch (error) {
                console.error('Error starting call:', error);
                endCall();
            }
        }

        async function answerCall(callId, offer, type) {
            isCaller = false;
            callType = type;
            currentCallId = callId;
            
            try {
                // Get user media based on call type
                const mediaConstraints = {
                    audio: true,
                    video: type === 'video'
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
                
                if (type === 'video') {
                    const localVideo = document.getElementById('localVideo');
                    localVideo.srcObject = localStream;
                }
                
                // Create peer connection
                peerConnection = createPeerConnection();
                
                // Set remote offer
                await peerConnection.setRemoteDescription(offer);
                
                // Create and set local answer
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // Save answer to database
                await database.ref('calls/' + currentCallId + '/answer').set(answer);
                
                // Show call screen
                showCallScreen(type);
                
                // Listen for ICE candidates from the other user
                database.ref('calls/' + currentCallId + '/iceCandidates').on('child_added', async (snapshot) => {
                    const candidateData = snapshot.val();
                    if (candidateData.from !== currentUser.uid) {
                        await peerConnection.addIceCandidate(candidateData.candidate);
                    }
                });
                
            } catch (error) {
                console.error('Error answering call:', error);
                endCall();
            }
        }

        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (currentCallId) {
                database.ref('calls/' + currentCallId).remove();
                currentCallId = null;
            }
            
            callScreen.style.display = 'none';
            isInCall = false;
            
            // Stop ringtone if playing
            if (ringtone) {
                ringtone.stop();
                ringtone = null;
            }
        }

        function playRingtone() {
            // Create a simple ringtone using Tone.js
            ringtone = new Tone.Oscillator("C4", "sine").toDestination();
            ringtone.volume.value = -10;
            ringtone.start();
            
            // Stop after 30 seconds if not answered
            setTimeout(() => {
                if (ringtone) {
                    ringtone.stop();
                    ringtone = null;
                }
            }, 30000);
        }

        // UI Functions
        function showScreen(screenElement) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show the requested screen
            screenElement.classList.add('active');
        }

        function showMainApp() {
            authScreen.classList.remove('active');
            profileSetupScreen.classList.remove('active');
            mainApp.style.display = 'flex';
            
            // Load user data
            loadUserData();
            loadContacts();
            loadFriendRequests();
            loadCallHistory();
        }

        function loadUserData() {
            if (!currentUser) return;
            
            getUserProfile(currentUser.uid).then(profile => {
                if (profile) {
                    // Update menu with user data
                    document.getElementById('menu-profile-name').textContent = profile.name;
                    document.getElementById('menu-profile-id').textContent = profile.userId;
                    document.getElementById('menu-profile-pic').textContent = profile.emoji;
                    
                    // Update edit profile form
                    document.getElementById('edit-profile-name').value = profile.name;
                    document.getElementById('edit-profile-bio').value = profile.bio || '';
                    document.getElementById('edit-profile-emoji').value = profile.emoji;
                }
            });
        }

        function loadContacts() {
            // In a real app, we would load from Firebase
            // For this demo, we'll create some mock contacts
            const contactList = document.getElementById('contact-list');
            contactList.innerHTML = '';
            
            const mockContacts = [
                { id: 'user1', name: 'Alex Johnson', emoji: 'üë®', online: true, lastSeen: Date.now() },
                { id: 'user2', name: 'Sam Smith', emoji: 'üë©', online: false, lastSeen: Date.now() - 3600000 },
                { id: 'user3', name: 'Taylor Swift', emoji: 'üé§', online: true, lastSeen: Date.now() }
            ];
            
            mockContacts.forEach(contact => {
                const contactItem = document.createElement('li');
                contactItem.className = 'contact-item';
                contactItem.dataset.contactId = contact.id;
                
                contactItem.innerHTML = `
                    <div class="contact-avatar">${contact.emoji}</div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-status">
                            ${contact.online ? '<span class="online-indicator"></span>Online' : 'Last seen ' + formatTime(contact.lastSeen)}
                        </div>
                    </div>
                    <div class="unread-count">2</div>
                `;
                
                contactItem.addEventListener('click', () => openChat(contact));
                contactList.appendChild(contactItem);
            });
        }

        function loadFriendRequests() {
            // In a real app, we would load from Firebase
            // For this demo, we'll create a mock request
            const requestsList = document.getElementById('requests-list');
            requestsList.innerHTML = '';
            
            const mockRequest = {
                id: 'req1',
                from: 'user4',
                name: 'Jamie Wilson',
                emoji: 'üë¶',
                timestamp: Date.now() - 1800000
            };
            
            const requestItem = document.createElement('li');
            requestItem.className = 'contact-item';
            
            requestItem.innerHTML = `
                <div class="contact-avatar">${mockRequest.emoji}</div>
                <div class="contact-info">
                    <div class="contact-name">${mockRequest.name}</div>
                    <div class="contact-status">Sent ${formatTime(mockRequest.timestamp)}</div>
                </div>
                <button class="btn btn-secondary accept-request">Accept</button>
            `;
            
            requestsList.appendChild(requestItem);
        }

        function loadCallHistory() {
            // In a real app, we would load from Firebase
            // For this demo, we'll create some mock call history
            const callsList = document.getElementById('calls-list');
            callsList.innerHTML = '';
            
            const mockCalls = [
                { id: 'call1', contact: { name: 'Alex Johnson', emoji: 'üë®' }, type: 'voice', duration: '5:32', timestamp: Date.now() - 86400000, missed: false },
                { id: 'call2', contact: { name: 'Sam Smith', emoji: 'üë©' }, type: 'video', duration: '12:45', timestamp: Date.now() - 172800000, missed: false },
                { id: 'call3', contact: { name: 'Taylor Swift', emoji: 'üé§' }, type: 'voice', duration: '0:00', timestamp: Date.now() - 3600000, missed: true }
            ];
            
            mockCalls.forEach(call => {
                const callItem = document.createElement('li');
                callItem.className = 'contact-item';
                
                callItem.innerHTML = `
                    <div class="contact-avatar">${call.contact.emoji}</div>
                    <div class="contact-info">
                        <div class="contact-name">${call.contact.name}</div>
                        <div class="contact-status">
                            ${call.missed ? 'Missed ' : ''}${call.type === 'video' ? 'Video' : 'Voice'} call ‚Ä¢ ${formatTime(call.timestamp)}
                            ${!call.missed && call.duration !== '0:00' ? ` ‚Ä¢ ${call.duration}` : ''}
                        </div>
                    </div>
                    <button class="icon-btn call-back-btn">üìû</button>
                `;
                
                callsList.appendChild(callItem);
            });
        }

        function openChat(contact) {
            currentContact = contact;
            currentChatId = getOrCreateChatId(currentUser.uid, contact.id);
            
            // Update chat header
            document.getElementById('chat-contact-name').textContent = contact.name;
            document.getElementById('chat-contact-avatar').textContent = contact.emoji;
            document.getElementById('chat-contact-status').textContent = contact.online ? 'Online' : 'Offline';
            
            // Show chat screen
            chatScreen.style.display = 'flex';
            contentArea.style.display = 'none';
            document.querySelector('.bottom-nav').style.display = 'none';
            
            // Load messages
            loadMessages(currentChatId);
            
            // Setup typing indicator
            setupTypingIndicator(currentChatId);
        }

        function loadMessages(chatId) {
            // In a real app, we would load from Firebase
            // For this demo, we'll create some mock messages
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            
            const mockMessages = [
                { id: 'msg1', text: 'Hey there! How are you?', sender: currentContact.id, timestamp: Date.now() - 3600000 },
                { id: 'msg2', text: 'I\'m doing great! Just working on this new app.', sender: currentUser.uid, timestamp: Date.now() - 3500000 },
                { id: 'msg3', text: 'That sounds interesting. Tell me more about it.', sender: currentContact.id, timestamp: Date.now() - 3400000 },
                { id: 'msg4', text: 'It\'s a real-time chat app with voice and video calling features.', sender: currentUser.uid, timestamp: Date.now() - 3300000 },
                { id: 'msg5', text: 'Wow, that\'s cool! Can I try it out?', sender: currentContact.id, timestamp: Date.now() - 3200000 }
            ];
            
            mockMessages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.sender === currentUser.uid ? 'me' : 'other'}`;
                
                messageElement.innerHTML = `
                    <div class="message-text">${message.text}</div>
                    <div class="message-time">${formatTime(message.timestamp)}</div>
                `;
                
                messagesContainer.appendChild(messageElement);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showCallScreen(type) {
            callScreen.style.display = 'flex';
            isInCall = true;
            
            if (type === 'voice') {
                voiceCallUI.style.display = 'block';
                videoCallUI.style.display = 'none';
                
                // Update call info
                document.getElementById('call-contact-name').textContent = currentContact.name;
                document.getElementById('call-avatar').textContent = currentContact.emoji;
                document.getElementById('call-status').textContent = isCaller ? 'Calling...' : 'Incoming call...';
            } else {
                voiceCallUI.style.display = 'none';
                videoCallUI.style.display = 'block';
            }
            
            // If we're receiving a call, play ringtone
            if (!isCaller) {
                playRingtone();
            }
        }

        // Event Listeners
        // Auth events
        showSignup.addEventListener('click', () => {
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
        });

        showLogin.addEventListener('click', () => {
            signupForm.style.display = 'none';
            loginForm.style.display = 'block';
        });

        loginBtn.addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // User logged in successfully
                    // Auth state listener will handle the rest
                })
                .catch((error) => {
                    alert('Login failed: ' + error.message);
                });
        });

        signupBtn.addEventListener('click', () => {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // User created successfully
                    // Will be directed to profile setup by auth state listener
                })
                .catch((error) => {
                    alert('Sign up failed: ' + error.message);
                });
        });

        saveProfileBtn.addEventListener('click', () => {
            const name = document.getElementById('profile-name').value;
            const bio = document.getElementById('profile-bio').value;
            const emoji = document.getElementById('profile-emoji').value;
            
            if (!name || !emoji) {
                alert('Please fill in all required fields');
                return;
            }
            
            const profileData = {
                name: name,
                bio: bio,
                emoji: emoji,
                dpUrl: emojiToSVG(emoji)
            };
            
            createUserProfile(currentUser.uid, profileData)
                .then(() => {
                    showMainApp();
                })
                .catch((error) => {
                    alert('Error saving profile: ' + error.message);
                });
        });

        // Main app events
        menuToggle.addEventListener('click', () => {
            sideMenu.classList.toggle('active');
        });

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                // Update active nav item
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                
                // Show the corresponding screen
                const screenId = item.dataset.screen;
                document.querySelectorAll('#content-area .screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');
                
                // Update header title
                currentScreenTitle.textContent = item.querySelector('span').textContent;
            });
        });

        backFromChat.addEventListener('click', () => {
            chatScreen.style.display = 'none';
            contentArea.style.display = 'block';
            document.querySelector('.bottom-nav').style.display = 'flex';
        });

        sendMessageBtn.addEventListener('click', () => {
            const messageText = messageInput.value.trim();
            if (messageText && currentChatId) {
                sendMessage(currentChatId, messageText)
                    .then(() => {
                        messageInput.value = '';
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                    });
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessageBtn.click();
            }
        });

        // Call events
        document.getElementById('voice-call-btn').addEventListener('click', () => {
            if (currentContact) {
                startCall(currentContact.id, 'voice');
            }
        });

        document.getElementById('video-call-btn').addEventListener('click', () => {
            if (currentContact) {
                startCall(currentContact.id, 'video');
            }
        });

        endCallBtn.addEventListener('click', endCall);
        videoEndCallBtn.addEventListener('click', endCall);

        // Modal events
        document.getElementById('edit-profile-menu').addEventListener('click', () => {
            editProfileModal.classList.add('active');
            sideMenu.classList.remove('active');
        });

        document.getElementById('add-friend-menu').addEventListener('click', () => {
            addFriendModal.classList.add('active');
            sideMenu.classList.remove('active');
        });

        document.getElementById('logout-menu').addEventListener('click', () => {
            auth.signOut();
        });

        closeModals.forEach(btn => {
            btn.addEventListener('click', () => {
                editProfileModal.classList.remove('active');
                addFriendModal.classList.remove('active');
            });
        });

        updateProfileBtn.addEventListener('click', () => {
            const name = document.getElementById('edit-profile-name').value;
            const bio = document.getElementById('edit-profile-bio').value;
            const emoji = document.getElementById('edit-profile-emoji').value;
            
            if (!name || !emoji) {
                alert('Please fill in all required fields');
                return;
            }
            
            const updates = {
                name: name,
                bio: bio,
                emoji: emoji,
                dpUrl: emojiToSVG(emoji)
            };
            
            updateUserProfile(currentUser.uid, updates)
                .then(() => {
                    editProfileModal.classList.remove('active');
                    loadUserData();
                })
                .catch(error => {
                    alert('Error updating profile: ' + error.message);
                });
        });

        sendRequestBtn.addEventListener('click', () => {
            const friendId = document.getElementById('friend-id').value;
            
            if (!friendId) {
                alert('Please enter a friend ID');
                return;
            }
            
            sendFriendRequest(friendId)
                .then(() => {
                    addFriendModal.classList.remove('active');
                    document.getElementById('friend-id').value = '';
                    alert('Friend request sent!');
                })
                .catch(error => {
                    alert('Error sending friend request: ' + error.message);
                });
        });

        // Listen for incoming calls
        database.ref('calls').on('child_added', (snapshot) => {
            const callData = snapshot.val();
            const callId = snapshot.key;
            
            // Check if this call is for the current user
            if (callData.to === currentUser.uid && !callData.answer && !isInCall) {
                // Show incoming call UI
                currentContact = { id: callData.from, name: 'Incoming Call', emoji: 'üìû' };
                showCallScreen(callData.type);
                
                // Set up answer functionality
                document.querySelector('.call-accept').addEventListener('click', () => {
                    answerCall(callId, callData.offer, callData.type);
                });
            }
        });

        // Initialize the app
        setupAuthStateListener();
    </script>
</body>
</html>
